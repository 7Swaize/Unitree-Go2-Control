<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>src.video_control.streamer &#8212; Unitree-Go2-Control 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for src.video_control.streamer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aiortc</span><span class="w"> </span><span class="kn">import</span> <span class="n">RTCPeerConnection</span><span class="p">,</span> <span class="n">RTCSessionDescription</span><span class="p">,</span> <span class="n">VideoStreamTrack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">av</span><span class="w"> </span><span class="kn">import</span> <span class="n">VideoFrame</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiohttp</span><span class="w"> </span><span class="kn">import</span> <span class="n">web</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="c1"># command to install rtc: pip install aiortc opencv-python</span>

<div class="viewcode-block" id="OpenCVStreamTrack">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.OpenCVStreamTrack">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenCVStreamTrack</span><span class="p">(</span><span class="n">VideoStreamTrack</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Video stream track that supplies frames from a local queue to WebRTC.</span>

<span class="sd">    This class wraps a `queue.Queue` of frames and presents them as</span>
<span class="sd">    an `aiortc.VideoStreamTrack`. It is designed for internal use</span>
<span class="sd">    by `WebRTCStreamer`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    frame_queue : queue.Queue</span>
<span class="sd">        A thread-safe queue containing frames to stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_queue</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_queue</span> <span class="o">=</span> <span class="n">frame_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">480</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_count</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="OpenCVStreamTrack.recv">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.OpenCVStreamTrack.recv">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive the next video frame for WebRTC.</span>

<span class="sd">        Retrieves the latest frame from the internal queue. If no</span>
<span class="sd">        frame is available, the last frame is repeated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        av.VideoFrame</span>
<span class="sd">            The video frame in BGR24 format, ready to be sent</span>
<span class="sd">            over WebRTC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pts</span><span class="p">,</span> <span class="n">time_base</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_timestamp</span><span class="p">()</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_frame</span> <span class="o">=</span> <span class="n">frame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frame_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">av_frame</span> <span class="o">=</span> <span class="n">VideoFrame</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;bgr24&quot;</span><span class="p">)</span>
        <span class="n">av_frame</span><span class="o">.</span><span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span>
        <span class="n">av_frame</span><span class="o">.</span><span class="n">time_base</span> <span class="o">=</span> <span class="n">time_base</span>
        <span class="k">return</span> <span class="n">av_frame</span></div>
</div>

    

<span class="c1"># TURN for public conn? https://www.100ms.live/blog/webrtc-python-react#interactive-connectivity-establishment---ice</span>
<div class="viewcode-block" id="WebRTCStreamer">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WebRTCStreamer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WebRTC streaming server for internal video broadcasting.</span>

<span class="sd">    Handles serving a video stream over a local WebRTC connection.</span>
<span class="sd">    This class uses:</span>

<span class="sd">        - `OpenCVStreamTrack` to pull frames from a queue</span>
<span class="sd">        - `aiortc` for WebRTC communication</span>
<span class="sd">        - `aiohttp` for HTTP endpoints and offer/answer negotiation</span>
<span class="sd">        - Asyncio and a background thread for the event loop</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    host : str</span>
<span class="sd">        The hostname or IP to bind the server (default &quot;0.0.0.0&quot;).</span>
<span class="sd">    port : int</span>
<span class="sd">        The TCP port for the server (default 8080).</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    _frame_queue : queue.Queue</span>
<span class="sd">        Queue for frames to send to WebRTC clients.</span>
<span class="sd">    _pcs : set</span>
<span class="sd">        Set of active RTCPeerConnections.</span>
<span class="sd">    _loop : asyncio.AbstractEventLoop</span>
<span class="sd">        Event loop for running the server in a background thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_pcs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_send_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="WebRTCStreamer.start_in_thread">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer.start_in_thread">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_in_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the WebRTC server in a daemon thread.</span>

<span class="sd">        Initializes a new asyncio event loop in a separate thread</span>
<span class="sd">        and runs the HTTP + WebRTC server asynchronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_init_event_loop</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_server</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_init_event_loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>



<div class="viewcode-block" id="WebRTCStreamer.send">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer.send">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueue a video frame for streaming.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frame : numpy.ndarray</span>
<span class="sd">            The video frame to send. If the internal queue exceeds</span>
<span class="sd">            5 frames, the oldest frames are discarded.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Non-blocking; frames are dropped if the queue is full.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># clear queue if frames full</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_frame_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">break</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="WebRTCStreamer.get_local_ip_address">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer.get_local_ip_address">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_local_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the local LAN IP address for client connections.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Local IP address (e.g., 192.168.x.x), or &quot;127.0.0.1&quot;</span>
<span class="sd">            if detection fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;8.8.8.8&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span> 
            <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">ip</span></div>

    

<div class="viewcode-block" id="WebRTCStreamer.get_port">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer.get_port">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the TCP port used by the server.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The port number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span></div>

    

<div class="viewcode-block" id="WebRTCStreamer._offer">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer._offer">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_offer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle incoming SDP offers from clients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        request : aiohttp.web.Request</span>
<span class="sd">            The HTTP POST request containing the SDP offer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        aiohttp.web.Response</span>
<span class="sd">            JSON response containing the SDP answer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">offer</span> <span class="o">=</span> <span class="n">RTCSessionDescription</span><span class="p">(</span><span class="n">sdp</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;sdp&quot;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>

        <span class="n">pc</span> <span class="o">=</span> <span class="n">RTCPeerConnection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pcs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
        
        <span class="n">track</span> <span class="o">=</span> <span class="n">OpenCVStreamTrack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_queue</span><span class="p">)</span>
        <span class="n">pc</span><span class="o">.</span><span class="n">addTrack</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>

        <span class="nd">@pc</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;connectionstatechange&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_connection_state_change</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WebRTC] Connection state: </span><span class="si">{</span><span class="n">pc</span><span class="o">.</span><span class="n">connectionState</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pc</span><span class="o">.</span><span class="n">connectionState</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;closed&quot;</span><span class="p">]:</span>
                <span class="k">await</span> <span class="n">pc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pcs</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>

        <span class="nd">@pc</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;iceconnectionstatechange&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_ice_state_change</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pc</span><span class="o">.</span><span class="n">iceConnectionState</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;closed&quot;</span><span class="p">]:</span>
                <span class="k">await</span> <span class="n">pc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pcs</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">pc</span><span class="o">.</span><span class="n">setRemoteDescription</span><span class="p">(</span><span class="n">offer</span><span class="p">)</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pc</span><span class="o">.</span><span class="n">createAnswer</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">pc</span><span class="o">.</span><span class="n">setLocalDescription</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">json_response</span><span class="p">({</span>
            <span class="s2">&quot;sdp&quot;</span><span class="p">:</span> <span class="n">pc</span><span class="o">.</span><span class="n">localDescription</span><span class="o">.</span><span class="n">sdp</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">pc</span><span class="o">.</span><span class="n">localDescription</span><span class="o">.</span><span class="n">type</span>
        <span class="p">})</span></div>



    <span class="c1"># AI GENERATED HTML - Shoutout Claude for this nice work</span>
<div class="viewcode-block" id="WebRTCStreamer._serve_html">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer._serve_html">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_serve_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serve the WebRTC demo HTML page to clients.</span>

<span class="sd">        This page connects to the WebRTC server and displays</span>
<span class="sd">        video frames in the browser. For internal use only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;!DOCTYPE html&gt;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">&lt;head&gt;</span>
<span class="s2">    &lt;title&gt;WebRTC Stream&lt;/title&gt;</span>
<span class="s2">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="s2">    &lt;style&gt;</span>
<span class="s2">        body {</span>
<span class="s2">            font-family: Arial, sans-serif;</span>
<span class="s2">            display: flex;</span>
<span class="s2">            flex-direction: column;</span>
<span class="s2">            align-items: center;</span>
<span class="s2">            padding: 20px;</span>
<span class="s2">            background: #f0f0f0;</span>
<span class="s2">        }</span>
<span class="s2">        h1 {</span>
<span class="s2">            color: #333;</span>
<span class="s2">        }</span>
<span class="s2">        video {</span>
<span class="s2">            border: 2px solid #333;</span>
<span class="s2">            border-radius: 8px;</span>
<span class="s2">            background: #000;</span>
<span class="s2">        }</span>
<span class="s2">        #status {</span>
<span class="s2">            margin-top: 10px;</span>
<span class="s2">            padding: 10px;</span>
<span class="s2">            border-radius: 4px;</span>
<span class="s2">            font-weight: bold;</span>
<span class="s2">        }</span>
<span class="s2">        .connecting { background: #fff3cd; color: #856404; }</span>
<span class="s2">        .connected { background: #d4edda; color: #155724; }</span>
<span class="s2">        .failed { background: #f8d7da; color: #721c24; }</span>
<span class="s2">        #debug {</span>
<span class="s2">            margin-top: 20px;</span>
<span class="s2">            padding: 10px;</span>
<span class="s2">            background: #fff;</span>
<span class="s2">            border: 1px solid #ccc;</span>
<span class="s2">            border-radius: 4px;</span>
<span class="s2">            font-family: monospace;</span>
<span class="s2">            font-size: 12px;</span>
<span class="s2">            max-width: 640px;</span>
<span class="s2">            text-align: left;</span>
<span class="s2">            white-space: pre-wrap;</span>
<span class="s2">            max-height: 300px;</span>
<span class="s2">            overflow-y: auto;</span>
<span class="s2">        }</span>
<span class="s2">    &lt;/style&gt;</span>
<span class="s2">&lt;/head&gt;</span>
<span class="s2">&lt;body&gt;</span>
<span class="s2">    &lt;h1&gt;WebRTC Stream&lt;/h1&gt;</span>
<span class="s2">    &lt;video id=&quot;video&quot; autoplay playsinline muted width=&quot;640&quot; height=&quot;480&quot;&gt;&lt;/video&gt;</span>
<span class="s2">    &lt;div id=&quot;status&quot; class=&quot;connecting&quot;&gt;Connecting...&lt;/div&gt;</span>
<span class="s2">    &lt;div id=&quot;debug&quot;&gt;Starting JavaScript...&lt;/div&gt;</span>

<span class="s2">    &lt;script&gt;</span>
<span class="s2">    (function() {</span>
<span class="s2">        const statusEl = document.getElementById(&#39;status&#39;);</span>
<span class="s2">        const debugEl = document.getElementById(&#39;debug&#39;);</span>
<span class="s2">        </span>
<span class="s2">        function log(msg) {</span>
<span class="s2">            const timestamp = new Date().toLocaleTimeString();</span>
<span class="s2">            const logMsg = `[$</span><span class="si">{timestamp}</span><span class="s2">] $</span><span class="si">{msg}</span><span class="s2">`;</span>
<span class="s2">            console.log(logMsg);</span>
<span class="s2">            debugEl.textContent = logMsg + &#39;</span><span class="se">\\</span><span class="s2">n&#39; + debugEl.textContent.split(&#39;</span><span class="se">\\</span><span class="s2">n&#39;).slice(0, 15).join(&#39;</span><span class="se">\\</span><span class="s2">n&#39;);</span>
<span class="s2">        }</span>

<span class="s2">        // Catch any uncaught errors</span>
<span class="s2">        window.onerror = function(msg, url, line, col, error) {</span>
<span class="s2">            log(`ERROR: $</span><span class="si">{msg}</span><span class="s2"> at $</span><span class="si">{line}</span><span class="s2">:$</span><span class="si">{col}</span><span class="s2">`);</span>
<span class="s2">            if (error) log(`Stack: $</span><span class="si">{error.stack}</span><span class="s2">`);</span>
<span class="s2">            return false;</span>
<span class="s2">        };</span>

<span class="s2">        log(&#39;Script loaded successfully&#39;);</span>

<span class="s2">        async function start() {</span>
<span class="s2">            try {</span>
<span class="s2">                log(&#39;Starting WebRTC connection...&#39;);</span>
<span class="s2">                </span>
<span class="s2">                // Check if browser supports WebRTC</span>
<span class="s2">                if (!window.RTCPeerConnection) {</span>
<span class="s2">                    throw new Error(&#39;WebRTC not supported in this browser&#39;);</span>
<span class="s2">                }</span>
<span class="s2">                </span>
<span class="s2">                log(&#39;Creating peer connection...&#39;);</span>
<span class="s2">                const pc = new RTCPeerConnection({</span>
<span class="s2">                    iceServers: []  // Local connection, no STUN/TURN needed</span>
<span class="s2">                });</span>

<span class="s2">                pc.onconnectionstatechange = () =&gt; {</span>
<span class="s2">                    log(`Connection state: $</span><span class="si">{pc.connectionState}</span><span class="s2">`);</span>
<span class="s2">                    if (pc.connectionState === &#39;connected&#39;) {</span>
<span class="s2">                        statusEl.textContent = &#39;Connected&#39;;</span>
<span class="s2">                        statusEl.className = &#39;connected&#39;;</span>
<span class="s2">                    } else if (pc.connectionState === &#39;failed&#39;) {</span>
<span class="s2">                        statusEl.textContent = &#39;Connection failed&#39;;</span>
<span class="s2">                        statusEl.className = &#39;failed&#39;;</span>
<span class="s2">                    } else if (pc.connectionState === &#39;disconnected&#39;) {</span>
<span class="s2">                        statusEl.textContent = &#39;Disconnected&#39;;</span>
<span class="s2">                        statusEl.className = &#39;failed&#39;;</span>
<span class="s2">                    }</span>
<span class="s2">                };</span>

<span class="s2">                pc.oniceconnectionstatechange = () =&gt; {</span>
<span class="s2">                    log(`ICE state: $</span><span class="si">{pc.iceConnectionState}</span><span class="s2">`);</span>
<span class="s2">                };</span>

<span class="s2">                pc.onicegatheringstatechange = () =&gt; {</span>
<span class="s2">                    log(`ICE gathering: $</span><span class="si">{pc.iceGatheringState}</span><span class="s2">`);</span>
<span class="s2">                };</span>

<span class="s2">                pc.onicecandidate = (event) =&gt; {</span>
<span class="s2">                    if (event.candidate) {</span>
<span class="s2">                        log(`ICE candidate: ${event.candidate.candidate.substring(0, 50)}...`);</span>
<span class="s2">                    } else {</span>
<span class="s2">                        log(&#39;ICE gathering complete&#39;);</span>
<span class="s2">                    }</span>
<span class="s2">                };</span>

<span class="s2">                // Receive remote video from server</span>
<span class="s2">                pc.ontrack = e =&gt; {</span>
<span class="s2">                    log(`Received $</span><span class="si">{e.track.kind}</span><span class="s2"> track`);</span>
<span class="s2">                    const video = document.getElementById(&#39;video&#39;);</span>
<span class="s2">                    </span>
<span class="s2">                    if (e.streams &amp;&amp; e.streams[0]) {</span>
<span class="s2">                        video.srcObject = e.streams[0];</span>
<span class="s2">                        log(&#39;Video stream attached&#39;);</span>
<span class="s2">                    } else {</span>
<span class="s2">                        log(&#39;WARNING: No stream in track event&#39;);</span>
<span class="s2">                    }</span>
<span class="s2">                    </span>
<span class="s2">                    video.onloadedmetadata = () =&gt; {</span>
<span class="s2">                        log(`Video size: $</span><span class="si">{video.videoWidth}</span><span class="s2">x$</span><span class="si">{video.videoHeight}</span><span class="s2">`);</span>
<span class="s2">                    };</span>
<span class="s2">                    </span>
<span class="s2">                    video.onplay = () =&gt; {</span>
<span class="s2">                        log(&#39;Video started playing!&#39;);</span>
<span class="s2">                    };</span>
<span class="s2">                    </span>
<span class="s2">                    video.onerror = (e) =&gt; {</span>
<span class="s2">                        log(`Video error: ${e.message || &#39;unknown&#39;}`);</span>
<span class="s2">                    };</span>
<span class="s2">                };</span>

<span class="s2">                // Create offer to receive video</span>
<span class="s2">                log(&#39;Creating offer...&#39;);</span>
<span class="s2">                const offer = await pc.createOffer({ </span>
<span class="s2">                    offerToReceiveVideo: true,</span>
<span class="s2">                    offerToReceiveAudio: false</span>
<span class="s2">                });</span>
<span class="s2">                </span>
<span class="s2">                log(&#39;Setting local description...&#39;);</span>
<span class="s2">                await pc.setLocalDescription(offer);</span>
<span class="s2">                log(&#39;Local description set&#39;);</span>

<span class="s2">                // Send SDP offer to Python server</span>
<span class="s2">                log(&#39;Sending offer to server...&#39;);</span>
<span class="s2">                const resp = await fetch(&quot;/offer&quot;, {</span>
<span class="s2">                    method: &quot;POST&quot;,</span>
<span class="s2">                    body: JSON.stringify({</span>
<span class="s2">                        sdp: pc.localDescription.sdp,</span>
<span class="s2">                        type: pc.localDescription.type</span>
<span class="s2">                    }),</span>
<span class="s2">                    headers: { &quot;Content-Type&quot;: &quot;application/json&quot; }</span>
<span class="s2">                });</span>

<span class="s2">                if (!resp.ok) {</span>
<span class="s2">                    const errorText = await resp.text();</span>
<span class="s2">                    throw new Error(`Server error $</span><span class="si">{resp.status}</span><span class="s2">: $</span><span class="si">{errorText}</span><span class="s2">`);</span>
<span class="s2">                }</span>

<span class="s2">                log(&#39;Server responded successfully&#39;);</span>
<span class="s2">                const answer = await resp.json();</span>
<span class="s2">                log(`Received answer ($</span><span class="si">{answer.type}</span><span class="s2">)`);</span>
<span class="s2">                </span>
<span class="s2">                log(&#39;Setting remote description...&#39;);</span>
<span class="s2">                await pc.setRemoteDescription(new RTCSessionDescription(answer));</span>
<span class="s2">                log(&#39;Remote description set - connection should establish...&#39;);</span>
<span class="s2">                </span>
<span class="s2">            } catch (error) {</span>
<span class="s2">                log(`FATAL ERROR: $</span><span class="si">{error.message}</span><span class="s2">`);</span>
<span class="s2">                if (error.stack) log(`Stack: $</span><span class="si">{error.stack}</span><span class="s2">`);</span>
<span class="s2">                statusEl.textContent = &#39;Error: &#39; + error.message;</span>
<span class="s2">                statusEl.className = &#39;failed&#39;;</span>
<span class="s2">            }</span>
<span class="s2">        }</span>

<span class="s2">        // Start immediately when DOM is ready</span>
<span class="s2">        if (document.readyState === &#39;loading&#39;) {</span>
<span class="s2">            document.addEventListener(&#39;DOMContentLoaded&#39;, start);</span>
<span class="s2">        } else {</span>
<span class="s2">            start();</span>
<span class="s2">        }</span>
<span class="s2">    })();</span>
<span class="s2">    &lt;/script&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">html_content</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/html&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="WebRTCStreamer._run_server">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer._run_server">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the aiohttp + WebRTC server asynchronously.</span>

<span class="sd">        Adds endpoints for &quot;/offer&quot; and &quot;/&quot; (HTML page) and keeps</span>
<span class="sd">        the server alive indefinitely.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_post</span><span class="p">(</span><span class="s2">&quot;/offer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offer</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serve_html</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">AppRunner</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_site</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">TCPSite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span></div>



<div class="viewcode-block" id="WebRTCStreamer.shutdown">
<a class="viewcode-back" href="../../../internal/video_control.html#src.video_control.streamer.WebRTCStreamer.shutdown">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shutdown all active connections and cleanup the server.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Closes all RTCPeerConnections.</span>
<span class="sd">        - Cleans up the aiohttp runner.</span>
<span class="sd">        - Should be called before program exit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_shutdown</span><span class="p">():</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">pc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pcs</span><span class="p">]</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">futures</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pcs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_runner&#39;</span><span class="p">):</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">_async_shutdown</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Unitree-Go2-Control</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">Public API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internal/index.html">Internal Implementation Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2026, Sachit Raheja.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>